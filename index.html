<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>กรอบรูป นิรโทษกรรมประชาชน</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">
    <style type="text/css">
        body {
            background: url("./bg.jpg");
            background-size: contain;
            background-size: cover;
            background-repeat: no-repeat;
            background-position: center center;
        }

        .secondstep {
            display: none;
        }
    </style>
</head>

<body>
    <nav class="navbar bg-primary mb-3">
        <div class="container-fluid">
            <a class="navbar-brand text-white" href="#">กรอบรูป นิรโทษกรรมประชาชน</a>
        </div>
    </nav>

    <div class="container">
        <div class="row">
            <div class="col-lg">
                <div class="card mb-3">
                    <div class="card-body">
                        <h5 class="card-title">เลือกรูป</h5>
                        <p class="mb-0">แนะนำให้ครอปรูปให้เป็นสี่เหลี่ยมจัตุรัสก่อน</p>
                        <p><small>รูปของท่านจะถูกประมวลผลในเครื่องแบบออฟไลน์
                                โดยไม่มีการส่งรูปไปที่เซิร์ฟเวอร์ของเรา นอกจากนี้
                                เว็บไม่มีการเก็บข้อมูลส่วนตัว ไม่มีการใช้คุกกี้ในทุกจุดประสงค์ (อาทิ
                                การติดตามผู้ใช้ การบันทึกข้อมูลในเครื่องชั่วคราว) และไม่มีการส่งกลับข้อมูลทางไกล
                                (telemetry) ไปสู่เซิร์ฟเวอร์ของเว็บนี้ และของบุคคลที่สามใดๆ</small></p>
                        <input type="file" id="fileInput" accept="image/*">
                    </div>
                </div>
                <div class="card mb-3 secondstep">
                    <div class="card-body">
                        <h5 class="card-title">ขยับข้อความ</h5>
                        <label for="scaleSlider" class="form-label">ขนาด เล็ก-ใหญ่</label>
                        <input type="range" class="form-range" id="scaleSlider" min="0.1" max="1" step="0.01" value="1">
                        <label for="scaleSlider" class="form-label">ซ้าย-ขวา</label>
                        <input type="range" class="form-range" id="xSlider" min="0" max="0" step="1" value="0">
                        <label for="ySlider" class="form-label">บน-ล่าง</label>
                        <input type="range" class="form-range" id="ySlider" min="0" max="0" step="1" value="0">
                        <button type="button" class="btn btn-success w-100" data-bs-toggle="modal"
                            data-bs-target="#finalRenderModal" onclick="finalRenderer()">
                            บันทึกรูป
                        </button>

                    </div>
                </div>
                <div class="alert alert-primary" role="alert">
                    อ่านร่างพระราชบัญญัตินิรโทษกรรมประชาชน ฉบับร่างของประชาชน <a
                        href="https://www.parliament.go.th/section77/manage/files/file_20240513163026_1_385.pdf">ได้ที่นี่</a>
                </div>
            </div>
            <div class="col-lg secondstep">
                <div>
                    <canvas id="canvas" class="border bg-white mb-3" width="1024" height="1024"></canvas>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="finalRenderModal" tabindex="-1" aria-labelledby="finalRenderModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="finalRenderModalLabel">กดค้าง-คลิกขวา บันทึกรูปด้านล่างได้เลย</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <img id="finalRender" width=" 100%" />
                </div>
            </div>
        </div>
    </div>



    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q"
        crossorigin="anonymous"></script>
    <script>
        // Element declarations (and some configs)
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        // canvas is 1024x1024 for decent resolution but we have to scale this down
        // so that display on devices are decent enough sort of
        canvas.style.width = "100%";

        const fileInput = document.getElementById('fileInput');
        const scaleSlider = document.getElementById('scaleSlider');
        const xSlider = document.getElementById('xSlider');
        const ySlider = document.getElementById('ySlider');

        const finalRender = document.getElementById('finalRender');

        const overlayImg = new Image();
        overlayImg.crossOrigin = "anonymous"
        overlayImg.src = './amnesty-overlay.png';

        let baseImage = null;
        let baseDims = { x: 0, y: 0, width: 0, height: 0 };
        let overlayScale = parseFloat(scaleSlider.value);
        let overlayX = 0;
        let overlayY = 0;

        function updateOffsetSliders() {
            // slider min-max settings so that leftmost scale sets logo to
            // topmost-leftmost position (and rightmost -> bottommost-rightmost)
            if (!overlayImg.complete) return;  // wait til image load properly
            const cw = canvas.width;
            const ch = canvas.height;
            // sorta fancy math
            const oW = overlayImg.naturalWidth * overlayScale;
            const oH = overlayImg.naturalHeight * overlayScale;
            const maxX = Math.max(0, cw - oW);
            const maxY = Math.max(0, ch - oH);
            xSlider.min = 0;
            xSlider.max = maxX;
            ySlider.min = 0;
            ySlider.max = maxY;
            overlayX = Math.min(Math.max(overlayX, 0), maxX);
            overlayY = Math.min(Math.max(overlayY, 0), maxY);
            xSlider.value = overlayX;
            ySlider.value = overlayY;
        }

        function drawAll() {
            // two step drawing: (1) user uploaded image, then (2) the logo
            const cw = canvas.width;
            const ch = canvas.height;
            ctx.clearRect(0, 0, cw, ch);
            if (baseImage) {
                ctx.drawImage(
                    baseImage,
                    0, 0, baseImage.width, baseImage.height,
                    baseDims.x, baseDims.y, baseDims.width, baseDims.height
                );
            }
            if (overlayImg.complete) {
                const oW = overlayImg.naturalWidth * overlayScale;
                const oH = overlayImg.naturalHeight * overlayScale;
                ctx.drawImage(
                    overlayImg,
                    overlayX, overlayY, oW, oH
                );
            }
        }

        // so that (1) offsetSliders are set to proper values, (2) canvas is 'ready'
        overlayImg.onload = () => {
            updateOffsetSliders();
            drawAll();
        };

        fileInput.addEventListener('change', event => {
            // event listener for image selection

            // show second step divs (sliders, canvas preview, save button)
            const elements = document.querySelectorAll('.secondstep');
            console.log(elements);
            for (let i = 0; i < elements.length; i++) {
                elements[i].style.display = "block";
            }

            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();

            reader.onload = e => {
                const img = new Image();
                img.onload = () => {
                    // resize image so that it is centred in the canvas
                    // TODO: scale the same way for the logo (will UI complexity too bad?)
                    const cw = canvas.width;
                    const ch = canvas.height;
                    const scale = Math.max(cw / img.width, ch / img.height);
                    const x = (cw - img.width * scale) / 2;
                    const y = (ch - img.height * scale) / 2;
                    baseImage = img;
                    baseDims = { x, y, width: img.width * scale, height: img.height * scale };
                    updateOffsetSliders();
                    drawAll();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        });

        // on all slider updates, redraw things--perf does not suck at least on iPhones
        scaleSlider.addEventListener('input', e => {
            overlayScale = parseFloat(e.target.value);
            updateOffsetSliders();
            drawAll();
        });
        xSlider.addEventListener('input', e => {
            overlayX = parseInt(e.target.value, 10);
            drawAll();
        });
        ySlider.addEventListener('input', e => {
            overlayY = parseInt(e.target.value, 10);
            drawAll();
        });

        if (overlayImg.complete) {
            updateOffsetSliders();
        }

        // fuck you Safari on iOS for not being able to save canvas directly to images
        // workaround: canvas content to base64 image/png -> put in <img> in modal
        function finalRenderer() {
            var data = canvas.toDataURL("image/png");
            finalRender.src = data;
        }
    </script>
</body>

</html>